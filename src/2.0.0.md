# Taffy

> Convention-over-Configuration REST framework for ColdFusion and Railo

<div class="links">
	<a href="https://github.com/atuttle/Taffy/archive/v2.0.0.zip">Taffy 2.0.0<strong>.zip</strong></a>
	&mdash;
	<a href="https://github.com/atuttle/Taffy/archive/v2.0.0.tar.gz">Taffy 2.0.0<strong>.tar.gz</strong></a>
</div>

[Release Notes](https://github.com/atuttle/Taffy/releases/tag/v2.0.0)
&mdash; [GitHub](https://github.com/atuttle/Taffy)
&mdash; [Mailing List](https://groups.google.com/forum/#!forum/taffy-users)
&mdash; [Roadmap](https://trello.com/b/Nz5nyqZg/)

[![Taffy Build Status](http://fusiongrokker.com:8080/job/Taffy/badge/icon)](http://fusiongrokker.com:8080/job/Taffy/)

## Quickstart: Your First API

**Application.cfc:**

	component extends="taffy.core.api" {}

**index.cfm:**

	<!-- this space left intentionally blank -->

**/resources/hello.cfc:**

	component extends="taffy.core.resource" taffy_uri="/hello" {

		function get(){
			return representationOf(['hello','world']);
		}

	}

Congratulations, you've just written your first API. Did you think it could be so simple?

Point your browser to the empty **index.cfm** file you created, and have a look at the dashboard. Click the "hello" row to expand it, and click the **Send** button to make a REST request. The results of your request are displayed below.

The response includes a **status code** and **status text**, as well as other **headers**, and the **response body** (if applicable). Taffy also shows you the amount of time the request took.

## More Guides

Some guides are too broad for this document. For your benefit, they are linked here:

* blah

## Configuration Reference

### Configuration via Metadata

### variables.framework settings

Default values:

	variables.framework = {
		reloadKey = "reload",
		reloadPassword = "true",
		reloadOnEveryRequest = false,

		endpointURLParam = "endpoint",

		representationClass = "taffy.core.nativeJsonRepresentation",

		dashboardKey = "dashboard",
		disableDashboard = false,
		disabledDashboardRedirect = "",

		jsonp = false,

		unhandledPaths = "/flex2gateway",
		allowCrossDomain = false,
		globalHeaders = structNew(),
		debugKey = "debug",

		useEtags = false,

		returnExceptionsAsJson = true,
		exceptionLogAdapter = "taffy.bonus.LogToEmail",
		exceptionLogAdapterConfig = {
			emailFrom = "api-error@yourdomain.com",
			emailTo = "you@yourdomain.com",
			emailSubj = "Exception Trapped in API",
			emailType = "html"
		},

		beanFactory = "",

		environments = {}
	};

#### reloadKey

**Available in:** Taffy 1.2+<br/>
**Type:** String<br/>
**Default:** "reload"<br/>
**Description:** Name of the url parameter that requests the framework to be reloaded. Used in combination with the reload password (see: reloadPassword), the framework will re-initialize itself. During re-initialization, all configuration settings are re-applied and all cached objects are cleared and reloaded. If the value of the key does not match the reload password, a reload will not be performed. This allows you to set a secret password to restrict control of reloading your API to trusted parties.

#### reloadPassword

**Available in:** Taffy 1.2+<br/>
**Type:** String<br/>
**Default:** "true"<br/>
**Description:** Accepted value of the url parameter that requests the framework to be reloaded. Used in combination with the reload key (see: reloadKey), the framework will re-initialize itself. During re-initialization, all configuration settings are re-applied and all cached objects are cleared and reloaded. If the value of the key does not match the reload password, a reload will not be performed. This allows you to set a secret password to restrict control of reloading your API to trusted parties.

#### reloadOnEveryRequest

**Available in:** Taffy 1.2+<br/>
**Type:** Boolean<br/>
**Default:** False<br/>
**Description:** Flag that indicates whether Taffy should reload cached values and configuration on every request. Useful in development; set to FALSE in production.

#### endpointURLParam

**Available in:** Taffy 1.3+<br/>
**Type:** String<br/>
**Default:** "endpoint"<br/>
**Description:** The query-string parameter name that can optionally be used to specify URI. Until now, URI formatting has been required to be index.cfm/URI; this parameter allows you to use index.cfm?endpoint=/URI. This setting (endpointURLParam) allows you to change the default parameter name of "endpoint" to something custom.

#### representationClass

**Available in:** Taffy 1.2+<br/>
**Type:** String<br/>
**Default:** "taffy.core.nativeJsonRepresentation"<br/>
**Description:** The CFC dot-notation path, or bean name, of the representation class that your API will use to serialize returned data for the client.

#### dashboardKey

**Available in:** Taffy 1.2+<br/>
**Deprecated **in: Taffy 1.3+<br/>
**Type:** String<br/>
**Default:** "dashboard"
Description: Name of the url parameter that displays the dashboard. The dashboard displays resources that your API is aware of, generates documentation about your API based on hint attributes, and contains a mock client to make testing your API easy.

#### disableDashboard

**Available in:** Taffy 1.2+<br/>
**Type:** Boolean<br/>
**Default:** False<br/>
**Description:** Whether or not Taffy will allow the dashboard to be displayed. If set to true, the dashboard key is simply ignored. You may wish to disable the dashboard in production, depending on whether or not you want customers/clients to be able to see it.

#### disabledDashboardRedirect

**Available in:** Taffy 1.3+<br/>
**Type:** String<br/>
**Default:** ""<br/>
**Description:** URL to which Taffy should redirect (302) the client/browser if the dashboard is disabled. If the dashboard is disabled and this value is blank, a simple 403 Forbidden response is sent instead.

#### jsonp

**Available in:** Taffy 2.0+<br/>
**Type:** Boolean/String<br/>
**Default:** false<br/>
**Description:** When false, JSONP is disabled. To enable it, change the value to a string, such as "callback". The value you specify will be the query parameter in which Taffy expects to find the JSONP callback name. Note: JSONP only works for GET requests (by design!)

#### unhandledPaths

**Available in:** Taffy 1.2+<br/>
**Type:** String (Comma-delimited list)<br/>
**Default:** "/flex2gateway"<br/>
**Description:** Set a list of paths (usually subfolders of the API) that you do not want Taffy to interfere with. Unless listed here, Taffy takes over the request lifecycle and does not execute the requested ColdFusion template.

#### allowCrossDomain

**Available in:** Taffy 1.2+<br/>
**Type:** Boolean<br/>
**Default:** False<br/>
**Description:** Whether or not to allow cross-domain access to your API. Turning this on adds the following headers:

	<cfheader name="Access-Control-Allow-Origin" value="*" />
	<cfheader name="Access-Control-Allow-Methods" value="#allowedVerbs#" />
	<cfheader name="Access-Control-Allow-Headers" value="Content-Type" />

The allowed verbs, of course, are the ones allowed by the requested resource, as well as OPTIONS.

#### globalHeaders

**Available in:** Taffy 1.2+<br/>
**Type:** Structure<br/>
**Default:** {}<br/>
**Description:** A structure where each key is the name of a header you want to return, such as "X-MY-HEADER" and the structure value is the header value.

Global headers are static. You set them on application initialization and they do not change. If you need dynamic headers, you can add them to each response at runtime using withHeaders().

#### debugKey

**Available in:** Taffy 1.2+<br/>
**Type:** String<br/>
**Default:** "debug"<br/>
**Description:** Name of the url parameter that enables CF Debug Output.

#### useEtags

**Available in:** Taffy 1.3+<br/>
**Type:** Boolean<br/>
**Default:** False<br/>
**Description:** Enable the use of HTTP ETags for caching purposes. Taffy will automatically handle both sending the server ETag value and detecting client supplied ETags (via the If-None-Match header) for you; simply turn this setting on.

**NOTE FOR RAILO USERS:** While it will not cause errors, the underlying Java code used in this feature was improperly implemented prior to Railo 4.0.? and this could result in your result data being sent as if it were changed when it in fact has not. (I'm not sure which Railo point release will include the fix. The latest as of this writing is version 4.0.2, and does not include it.) Adobe ColdFusion is unaffected.

#### returnExceptionsAsJson

**Available in:** Taffy 1.2+<br/>
**Type:** Boolean<br/>
**Default:** true<br/>
**Description:** When an error occurs that is not otherwise handled, this option tells Taffy to attempt to format the error information as JSON and return that (regardless of the requested return format).

#### exceptionLogAdapter

**Available in:** Taffy 1.2+<br/>
**Type:** String<br/>
**Default:** "taffy.bonus.LogToEmail"<br/>
**Description:** CFC dot-notation path to the exception logging adapter you want to use. Default adapter simply emails all exceptions. See Exception Logging Adapters for more details.

#### exceptionLogAdapterConfig

**Available in:** Taffy 1.2+<br/>
**Type:** Any<br/>
**Default:** See values at top of this page<br/>
**Description:** Configuration that your chosen logging adapter requires. Can be any data type. See Exception Logging Adapters for more details.

#### beanFactory

**Available in:** Taffy 1.2+<br/>
**Type:** Object Instance<br/>
**Default:** ""<br/>
**Description:** Already instantiated and cached (e.g. in Application scope) object instance of your external bean factory. Not required in order to use Taffy's built-in factory.

#### environments

**Available in:** Taffy 1.3+<br/>
**Type:** Structure<br/>
**Default:** {}<br/>
**Description:** Environment-specific overrides to any framework settings. Applied after general variables.framework settings, and after configureTaffy() has been called. See Environment Specific Configuration for more details.

## Index of API Methods

### Application.cfc

#### getPath()

**Parameters:** _(none)_

This method is provided as an extension point. On Adobe ColdFusion ("ACF") 9, installed in standard entire-server mode, no change should be necessary. However, if ACF is installed on another JEE app server (i.e. Tomcat, Glassfish, etc), or on JRun but using an EAR/WAR setup, then you may need to override this method to make Taffy work on your server. See [[GetPath Setups]] for more information.

#### getBasicAuthCredentials()

**Parameters:** _(none)_

**Added in Taffy 1.3.** This method returns a structure with two keys: `username`, and `password`. When the client does not provide HTTP Basic Auth credentials, the username and password keys will be blank. When the client does provide them, the values will be available in these keys.

This method is only available inside your Application.cfc. If, for example, you need access to the username in a resource, you can use this method inside onTaffyRequest and add the username to the requestArguments structure.

#### getBeanFactory()

**Parameters:** _(none)_

Returns whatever bean factory you may have set into Taffy, if any. If using the `/resources` folder, it returns Taffy's built-in factory.

#### newRepresentation()

**Use it inside:** onTaffyRequest<br/>
**Parameters:**

* **class (string)** - the dot-notation cfc path (or bean id if managing the class with a bean factory, including the built-in factory) for the representation class. Optional. Default value is the defined representation class. If you're using the framework default representation class, it's `nativeJsonRepresentation`.

Use this method inside onTaffyRequest when you want to _abort_ the request with some specific message or data. Use the `setData` method on the returned representation class to put your data/message into it before returning it.

#### onTaffyRequest()

**Parameters:**

* **verb (string)** - The HTTP request verb provided by the client
* **cfc (string)** - The CFC name (minus ".cfc") that would handle the request. (Bean Name, if using an external bean factory.)
* **requestArguments (struct)** - A structure containing all of the arguments of the request, including tokens from the URI as well as any query string parameters.
* **mimeExt (string)** - The mime extension (e.g. "json" - NOT the full mime type, e.g. "application/json")
* **headers (struct)** - A structure containing each header from the request, as sent by the client.

This method is optional, and allows you to inspect and potentially abort an API request in a way that adheres to the HTTP specification. If you choose not to override it (by implementing it in your Application.cfc), it will always return true, allowing the request to continue. If you implement it, you can check for things like an API key, or whether or not the customer has paid for your service, and return something other than the data that they are requesting.

If you do not return TRUE, allowing the request to continue as normal, then Taffy expects you to return a **[representation](/atuttle/Taffy/wiki/Using-a-Custom-Representation-Class)** (either the default class, or a custom one) that it should immediately return to the consumer, serialized to the appropriate format. If you simply want to return with a status code of 403 (which indicates "Not Allowed"), you could do this:

	return newRepresentation().noData().withStatus(403);

Alternately, you could return some data to indicate that they owe you money or something:

	return newRepresentation()
          .setData({error="Your account is past due. Please email accounts payable."})
          .withStatus(403);

The options here are limited only by your imagination.

You can add data to the **requestArguments** structure and this will be passed on to any resource that handles the request. Simply add a key to the structure:

	function onTaffyRequest(verb, cfc, requestArguments, mimeExt, headers){
	  arguments.requestArguments.myData = "myvalue";
	  return true;
	}

In your resource:

	function get(myData){
	  //arguments.myData = myValue
	}

### Resources

### Custom Representation Classes